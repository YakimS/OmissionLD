function config = experiment_config()
% EXPERIMENT_CONFIG Configuration parameters for oddball paradigm experiment
%
% Returns a structure with all experiment parameters
%
% Experiment Design:
%   - 3 blocks (one for each standard tone: low, medium, high)
%   - Random block order
%   - Each block contains standard tones with occasional deviants and omissions
%
% Trial Types:
%   - Standard: The designated standard tone for the block
%   - Deviant:  One of the other two tones (oddball)
%   - Omission: No tone played (silence)
%
% IMPORTANT CONSTRAINT:
%   At least 5 standard trials must occur between any two deviant trials
%   (deviants or omissions). This ensures the standard tone is well-established
%   before each deviant. The configuration will error if trials_per_block is
%   too small to satisfy this constraint.
%
% Usage:
%   config = experiment_config();
%   run_experiment(config);

    %% ===== BASIC EXPERIMENT PARAMETERS =====

    % Number of trials per block (total stimuli presentations per block)
    config.trials_per_block = 200;

    % Stimulus Onset Asynchrony (SOA): Time between tone onsets in milliseconds
    config.stimulus_onset_asynchrony_ms = 500;  % 500 ms between tones

    % Baseline/Habituation trials: Number of initial trials with ONLY standard tone
    % (no deviants or omissions to establish the standard)
    config.baseline_trials = 20;

    %% ===== TRIAL TYPE PROBABILITIES =====

    % Omission percentage: Percentage of trials where NO tone is played
    config.omission_percentage = 10;  % 10% omissions

    % Deviant percentage: Percentage of trials with deviant tones (other two tones)
    % This will be split equally between the two deviant tones
    config.deviant_percentage = 20;  % 20% deviants total (10% each tone)

    % Standard percentage is automatically calculated:
    % standard_percentage = 100 - omission_percentage - deviant_percentage
    % In this case: 70% standard, 10% omission, 20% deviant

    %% ===== TONE PARAMETERS =====

    % Tone file paths (generated by generate_tones.m)
    config.tone_dir = 'tones';
    config.tone_files = {
        'tone_low_650Hz.wav',
        'tone_medium_1428Hz.wav',
        'tone_high_3137Hz.wav'
    };

    % Tone labels for clarity
    config.tone_labels = {'Low (650 Hz)', 'Medium (1428 Hz)', 'High (3137 Hz)'};

    %% ===== TIMING PARAMETERS =====

    % Initial pause after "experiment starts now" message (seconds)
    config.initial_pause_duration = 5;  % 5 seconds

    % Inter-block interval (seconds) - pause between blocks
    config.inter_block_interval = 10;  % 10 seconds

    %% ===== OUTPUT PARAMETERS =====

    % Results directory
    config.results_dir = 'results';

    % Generate timestamp for this experiment session
    config.timestamp = datestr(now, 'yyyy-mm-dd_HH-MM-SS');

    % Results filename
    config.results_filename = sprintf('experiment_results_%s.mat', config.timestamp);

    %% ===== DISPLAY PARAMETERS =====

    % Verbose output during experiment
    config.verbose = true;

    % Show progress every N trials
    config.progress_interval = 50;

    %% ===== VALIDATION =====

    % Validate that percentages don't exceed 100%
    total_percentage = config.omission_percentage + config.deviant_percentage;
    if total_percentage >= 100
        error('Total of omission_percentage and deviant_percentage must be less than 100%%');
    end

    % Validate that there are enough trials after baseline for deviants/omissions
    trials_after_baseline = config.trials_per_block - config.baseline_trials;
    if trials_after_baseline <= 0
        error('baseline_trials must be less than trials_per_block');
    end

    % Calculate expected trial counts (for information)
    config.expected_standard_count = round((100 - total_percentage) / 100 * trials_after_baseline) + config.baseline_trials;
    config.expected_omission_count = round(config.omission_percentage / 100 * trials_after_baseline);
    config.expected_deviant_count = round(config.deviant_percentage / 100 * trials_after_baseline);

    % Validate spacing constraint: at least 5 standard trials between deviants
    % This ensures the standard tone is well-established before each deviant
    min_spacing = 5;
    n_omissions = config.expected_omission_count;
    n_deviants_total = config.expected_deviant_count;
    n_non_standards = n_omissions + n_deviants_total;

    % Minimum trials needed: N non-standards + (N-1) * 5 standards between them
    if n_non_standards > 0
        min_trials_after_baseline = n_non_standards + (n_non_standards - 1) * min_spacing;

        if trials_after_baseline < min_trials_after_baseline
            min_total_trials = config.baseline_trials + min_trials_after_baseline;
            error(['CONFIGURATION ERROR: Not enough trials to maintain minimum spacing.\n' ...
                   'CONSTRAINT: At least %d standard trials must occur between any two deviants (including omissions).\n\n' ...
                   'Current configuration:\n' ...
                   '  Trials per block: %d\n' ...
                   '  Baseline trials: %d\n' ...
                   '  Trials after baseline: %d\n' ...
                   '  Expected non-standard trials: %d\n' ...
                   '  Minimum trials after baseline needed: %d\n\n' ...
                   'SOLUTION: Increase trials_per_block to at least %d\n' ...
                   '          (or reduce omission_percentage and/or deviant_percentage)'], ...
                   min_spacing, config.trials_per_block, config.baseline_trials, ...
                   trials_after_baseline, n_non_standards, min_trials_after_baseline, ...
                   min_total_trials);
        end
    end

    %% ===== DISPLAY CONFIGURATION SUMMARY =====

    if config.verbose
        fprintf('\n========================================\n');
        fprintf('EXPERIMENT CONFIGURATION\n');
        fprintf('========================================\n');
        fprintf('Trials per block:          %d\n', config.trials_per_block);
        fprintf('Baseline trials:           %d\n', config.baseline_trials);
        fprintf('SOA:                       %d ms\n', config.stimulus_onset_asynchrony_ms);
        fprintf('Omission percentage:       %d%%\n', config.omission_percentage);
        fprintf('Deviant percentage:        %d%%\n', config.deviant_percentage);
        fprintf('Standard percentage:       %d%%\n', 100 - total_percentage);
        fprintf('\nExpected trial counts (per block):\n');
        fprintf('  Standard:                %d\n', config.expected_standard_count);
        fprintf('  Omission:                %d\n', config.expected_omission_count);
        fprintf('  Deviant:                 %d\n', config.expected_deviant_count);
        fprintf('========================================\n\n');
    end
end
